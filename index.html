<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Fun</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header
col-xs-12 col-xs-offset-0 col-sm-8 col-sm-offset-1 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Voice-Fun</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</div>
<div class="container">
    <div id="recordingslist">

        <div id="voice_msg_template"
             class="col-xs-12 col-xs-offset-0 col-sm-8 col-sm-offset-1 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4">
            <div class="avatar"></div>
            <audio src="#" controls></audio>

        </div>
    </div>
</div>
<div class="footer">
    <div class="container">
        <div class="row">
            <div id="push_to_talk" class="btn btn-success
            col-xs-12 col-xs-offset-0 col-sm-8 col-sm-offset-1 col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4">
                Push to Talk</div>
        </div>
    </div>
</div>
<script src="recorderjs/recorder.js"></script>
<script src="jquery-2.1.1.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="//www.parsecdn.com/js/parse-1.3.0.min.js"></script>
<script src="guid.js"></script>
<script src="jquery.cookie.js"></script>
<script src="identicons/pnglib.js"></script>
<script src="identicons/identicon.js"></script>
<script>
    var myId = $.cookie("myId") || guid();
    $.cookie("myId", myId);
    console.log("set id: " + myId);


    jQuery(function($) {
        // Template
        var voice_msg_template = $("#voice_msg_template").clone();
        //$("#recordingslist").empty();
        // End of Template

        function __log(e, data) {
            //console.log(e);
            //console.log(data);
        }

        var audio_context;
        var recorder;

        function startUserMedia(stream) {
            var input = audio_context.createMediaStreamSource(stream);
            __log('Media stream created.');

            recorder = new Recorder(input);
            __log('Recorder initialised.');
        }

        function startRecording() {
            recorder && recorder.record();
            __log('Recording...');
        }

        function stopRecording() {
            recorder && recorder.stop();
            __log('Stopped recording.');

            // create WAV download link using audio data blob
            createDownloadLink();

            recorder.clear();
        }

        function createDownloadLink() {
            recorder && recorder.exportWAV(function(blob) {

                var VoiceClip = Parse.Object.extend("VoiceClip");
                var voiceClip = new VoiceClip();

                voiceClip.save({voice: blob, client_id: myId}).then(function(object) {
                    console.log("saved a clicp of id" + myId);
                    console.log(object);
                    var url = URL.createObjectURL(blob);
                    var voice_msg = voice_msg_template.clone();
                    var data = new Identicon(myId, 30).toString();
                    var identicon = $('<img width=30 height=30 src="data:image/png;base64,' + data + '">');
                    voice_msg.find(".avatar").append(identicon);
                    voice_msg.find("audio").attr("src", url);
                    $("#recordingslist").append(voice_msg);

                });
            });
        }


        $(document).ready(function() {
            // TODO(zzn): putting credentials in the code-base may not be a good idea, but Parse may be different.
            Parse.initialize("pQkbpqhpAJAhcr2PmlUQBmTMhof6YEyRI6htkw38", "Y9u8JIjstr5WVjcYN4cMvwVhIXK4UigS7rxlcj5i");

            try {
                // webkit shim
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
                window.URL = window.URL || window.webkitURL;

                audio_context = new AudioContext;
                __log('Audio context set up.');
                __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
            } catch (e) {
                alert('No web audio support in this browser!');
            }

            navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
                __log('No live audio input: ' + e);
            });

            var ON = 1;
            var OFF = 0;
            var status = OFF;
            var start = function() {
                status = ON;
                startRecording();
                $("#push_to_talk").removeClass("btn-success");
                $("#push_to_talk").addClass("btn-default");
            };
            var stop = function() {
                status = OFF;
                stopRecording();
                $("#push_to_talk").removeClass("btn-default");
                $("#push_to_talk").addClass("btn-success");
            };
            $("#push_to_talk").click(function(){
                if (status == OFF) { // was off, turn on
                    start();
                } else { // was on ignore.
                    stop();
                }
            });

        });
    });
</script>

<!-- Start of Woopra Code -->
<script>
    (function(){
        var t,i,e,n=window,o=document,a=arguments,s="script",r=["config","track","identify","visit","push","call","trackForm","trackClick"],c=function(){var t,i=this;for(i._e=[],t=0;r.length>t;t++)(function(t){i[t]=function(){return i._e.push([t].concat(Array.prototype.slice.call(arguments,0))),i}})(r[t])};for(n._w=n._w||{},t=0;a.length>t;t++)n._w[a[t]]=n[a[t]]=n[a[t]]||new c;i=o.createElement(s),i.async=1,i.src="//static.woopra.com/js/w.js",e=o.getElementsByTagName(s)[0],e.parentNode.insertBefore(i,e)
    })("woopra");

    woopra.config({
        domain: 'voice-fun.zzn.im'
    });
    woopra.track();
</script>
<!-- End of Woopra Code -->
</body>
</html>